name: Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "é€‰æ‹©ç‰ˆæœ¬ç±»å‹"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      custom_changelog:
        description: "é¢å¤–çš„ Changelog å†…å®¹ (å¯é€‰)"
        required: false
        type: string

# å¹¶å‘æ§åˆ¶
concurrency:
  group: "release"
  cancel-in-progress: true

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # æ·»åŠ  token ä»¥ç¡®ä¿æœ‰è¶³å¤Ÿçš„æƒé™æ¨é€
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: é…ç½® Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: å‡†å¤‡è‡ªå®šä¹‰ Changelog
        if: ${{ inputs.custom_changelog != '' }}
        run: |
          echo "${{ inputs.custom_changelog }}" > custom_changelog.md

      - name: æ˜¾ç¤ºå½“å‰ Changelog
        run: |
          echo "=== å½“å‰ CHANGELOG å†…å®¹ ==="
          if [ -f "CHANGELOG.md" ]; then
            cat CHANGELOG.md
          else
            echo "CHANGELOG.md æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          echo "=== CHANGELOG å†…å®¹ç»“æŸ ==="

      - name: åˆ›å»ºæ–°ç‰ˆæœ¬
        id: version
        run: |
          # æ‰§è¡Œ standard-version
          if ! npm run release:${{ github.event.inputs.version_type }}; then
            echo "è¿è¡Œ standard-version å¤±è´¥" 
            exit 1
          fi

          echo "=== æ–°ç”Ÿæˆçš„ CHANGELOG å†…å®¹ ==="
          cat CHANGELOG.md
          echo "=== CHANGELOG å†…å®¹ç»“æŸ ==="

          # å¤„ç†æ‰€æœ‰ç‰ˆæœ¬æ ‡é¢˜çš„æ ¼å¼
          echo "å¤„ç†æ‰€æœ‰ç‰ˆæœ¬æ ‡é¢˜æ ¼å¼..."
          awk '
            BEGIN { inContent = 0 }
            
            # ç¬¬ä¸€ä¸ªç©ºè¡Œä¹‹å‰çš„å†…å®¹ä¿æŒä¸å˜
            NF == 0 && !inContent {
              print;
              inContent = 1;
              next;
            }
            
            # å¯¹äºç‰ˆæœ¬å·æ ‡é¢˜è¿›è¡Œè½¬æ¢
            /^#{1,3} +(\[?[0-9]+\.[0-9]+\.[0-9]+\]?|\[?[0-9]+\.[0-9]+\.[0-9]+\]? +\([0-9]{4}-[0-9]{2}-[0-9]{2}\))/ {
              # æå–ç‰ˆæœ¬å·
              match($0, /[0-9]+\.[0-9]+\.[0-9]+/);
              version = substr($0, RSTART, RLENGTH);
              
              # å¦‚æœæ˜¯ major ç‰ˆæœ¬ (x.0.0)ï¼Œä½¿ç”¨ä¸€çº§æ ‡é¢˜
              if (version ~ /[0-9]+\.0\.0/) {
                sub(/^#{1,3}/, "#");
              }
              # minor å’Œ patch ç‰ˆæœ¬ä½¿ç”¨äºŒçº§æ ‡é¢˜
              else {
                sub(/^#{1,3}/, "##");
              }
              print;
              next;
            }
            
            # å…¶ä»–è¡Œä¿æŒä¸å˜
            {
              print;
            }
          ' CHANGELOG.md > temp_changelog.md
          mv temp_changelog.md CHANGELOG.md

          # å¦‚æœæœ‰è‡ªå®šä¹‰ changelog
          if [ -f "custom_changelog.md" ]; then
            # æ·»åŠ ç‰¹æ®Šæ ·å¼æ ‡é¢˜å’Œè‡ªå®šä¹‰å†…å®¹
            echo "### ğŸ”” æ›´æ–°è¯´æ˜" > formatted_custom_changelog.md
            cat custom_changelog.md >> formatted_custom_changelog.md

            # æ’å…¥è‡ªå®šä¹‰å†…å®¹åˆ°ç‰ˆæœ¬æ ‡é¢˜ä¹‹å
            awk '
              /^#{1,2} \[?[0-9]+\.[0-9]+\.[0-9]+\]?/{
                if (!found) {
                  print;
                  system("cat formatted_custom_changelog.md");
                  found=1;
                } else {
                  print;
                }
              }
              !/^#{1,2} \[?[0-9]+\.[0-9]+\.[0-9]+\]?/{print}
            ' CHANGELOG.md > temp_changelog.md

            # æ›¿æ¢åŸæ–‡ä»¶
            mv temp_changelog.md CHANGELOG.md
            rm formatted_custom_changelog.md
          fi

          # æ›´æ–°å†å²ç‰ˆæœ¬ä¿¡æ¯
          # è·å–å½“å‰ä¸»ç‰ˆæœ¬å·
          CURRENT_VERSION=$(node -p "require('./package.json').version" | cut -d. -f1)
          if [ -z "$CURRENT_VERSION" ]; then
              echo "é”™è¯¯: æ— æ³•è·å–ç‰ˆæœ¬å·"
              exit 1
          fi

          echo "å½“å‰ä¸»ç‰ˆæœ¬å·: $CURRENT_VERSION"

          # ç¡®ä¿ changelogs ç›®å½•å­˜åœ¨
          mkdir -p changelogs

          # æå–å½“å‰ä¸»ç‰ˆæœ¬çš„å˜æ›´æ—¥å¿—
          MAJOR_VERSION_FILE="changelogs/CHANGELOG-${CURRENT_VERSION}.0.md"
          echo "åˆ›å»ºæ–‡ä»¶: $MAJOR_VERSION_FILE"

          # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–å½“å‰ä¸»ç‰ˆæœ¬çš„å˜æ›´æ—¥å¿—
          awk -v version="$CURRENT_VERSION" '
              BEGIN { in_version = 0 }
              
              # åŒ¹é…ç‰ˆæœ¬å·è¡Œ
              /^#{1,2} \[?[0-9]+\.[0-9]+\.[0-9]+\]?/ {
                  # æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ä¸»ç‰ˆæœ¬çš„ç‰ˆæœ¬å·
                  if ($0 ~ "^#{1,2} \\[?" version "\\.[0-9]+\\.[0-9]+\\]?") {
                      print;  # æ‰“å°ç‰ˆæœ¬å·è¡Œ
                      in_version = 1;
                  } else if (in_version) {
                      # å¦‚æœé‡åˆ°å…¶ä»–ç‰ˆæœ¬å·ä¸”æ­£åœ¨å¤„ç†å½“å‰ç‰ˆæœ¬ï¼Œåˆ™é€€å‡º
                      exit;
                  }
                  next;
              }
              
              # å¦‚æœåœ¨å½“å‰ç‰ˆæœ¬èŒƒå›´å†…ï¼Œæ‰“å°æ‰€æœ‰éç‰ˆæœ¬å·è¡Œ
              in_version { print }
          ' CHANGELOG.md > "$MAJOR_VERSION_FILE"

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”ŸæˆæˆåŠŸ
          if [ ! -s "$MAJOR_VERSION_FILE" ]; then
              echo "é”™è¯¯: æ— æ³•æå–å½“å‰ä¸»ç‰ˆæœ¬çš„å˜æ›´æ—¥å¿—"
              exit 1
          fi

          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œä¿å­˜åŸæœ‰å†…å®¹ï¼ˆä¸åŒ…æ‹¬ Previous Changelogs éƒ¨åˆ†ï¼‰
          awk '/^## Previous Changelogs/{exit} {print}' CHANGELOG.md > temp_main.md

          # æ·»åŠ  Previous Changelogs æ ‡é¢˜
          echo -e "\n\n## Previous Changelogs\n" > temp_changelog.md

          # è·å–æ‰€æœ‰ç‰ˆæœ¬çš„ tagï¼Œå¹¶æŒ‰ç‰ˆæœ¬å·åˆ†ç»„
          for major in $(git tag -l "v*" | cut -d. -f1 | sort -u -V); do
              # è·å–è¯¥ä¸»ç‰ˆæœ¬çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ª tag
              FIRST_TAG=$(git tag -l "${major}.*" | sort -V | head -n1)
              LAST_TAG=$(git tag -l "${major}.*" | sort -V | tail -n1)

              # è·å–å¯¹åº”çš„æ—¥æœŸ
              START_DATE=$(git log -1 --format=%ad --date=short $FIRST_TAG)
              if [ "$major" = "v$CURRENT_VERSION" ]; then
                  END_DATE="Present"
              else
                  END_DATE=$(git log -1 --format=%ad --date=short $LAST_TAG)
              fi

              # ç§»é™¤ v å‰ç¼€
              MAJOR_NUM=${major#v}
              echo "### ${MAJOR_NUM}.x ($START_DATE - $END_DATE)" >> temp_changelog.md
              
              if [ "$major" = "v$CURRENT_VERSION" ]; then
                  echo "Current changelog" >> temp_changelog.md
                  echo "" >> temp_changelog.md
                  echo "See [${MAJOR_NUM}.x changelog](changelogs/CHANGELOG-${MAJOR_NUM}.0.md)" >> temp_changelog.md
              else
                  echo "See [${MAJOR_NUM}.x changelog](changelogs/CHANGELOG-${MAJOR_NUM}.0.md)" >> temp_changelog.md
              fi
              
              echo "" >> temp_changelog.md
          done

          # åˆå¹¶ä¸»è¦å†…å®¹å’Œå†å²ç‰ˆæœ¬ä¿¡æ¯
          cat temp_main.md temp_changelog.md > CHANGELOG.md
          rm temp_main.md temp_changelog.md

          # æäº¤æ›´æ”¹
          git add CHANGELOG.md "$MAJOR_VERSION_FILE"
          git commit --amend --no-edit || {
              echo "æäº¤æ›´æ”¹å¤±è´¥"
              exit 1
          }

          # è·å–æ–°ç‰ˆæœ¬å·
          NEW_VERSION=$(node -p "require('./package.json').version")
          if [ -z "$NEW_VERSION" ]; then
            echo "è·å–ç‰ˆæœ¬å·å¤±è´¥"
            exit 1
          fi
          echo "version=v${NEW_VERSION}" >> $GITHUB_OUTPUT

      - name: æ„å»º
        run: |
          if ! npm run clean; then
            echo "æ¸…ç†æ„å»ºå¤±è´¥"
            exit 1
          fi

          if ! npm run build:esbuild; then
            echo "æ„å»ºå¤±è´¥"
            exit 1
          fi

      - name: æ¨é€å˜æ›´
        run: |
          git push --follow-tags origin master || {
            echo "æ¨é€åˆ°è¿œç¨‹ä»“åº“å¤±è´¥"
            exit 1
          }

      - name: è·å– Changelog
        id: changelog
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "CHANGELOG.md æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

          CHANGELOG=$(cat CHANGELOG.md)
          {
            echo "changelog<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          generate_release_notes: false
          body: |
            Please refer to [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) for details.
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
